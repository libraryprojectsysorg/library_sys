package org.library;

import org.junit.jupiter.api.*;
import org.junit.jupiter.api.io.TempDir;
import org.library.domain.User;
import org.library.Service.strategy.UserFileHandler;
import org.mockito.MockedStatic;

import java.nio.file.Path;
import java.util.ArrayList;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.mockStatic;

class UserFileHandlerTest {

    @TempDir
    Path tempDir;

    private String testFile;

    @BeforeEach
    void setUp() {
        testFile = tempDir.resolve("users_test.txt").toString();
        UserFileHandler.setUsersFile(testFile);
        // نضمن إن الملف فاضي
        new java.io.File(testFile).delete();
    }

    @AfterEach
    void tearDown() {
        new java.io.File(testFile).delete();
    }

    @Test
    void saveUser_ShouldSaveRegularUser_WithAutoGeneratedId() {
        boolean saved = UserFileHandler.saveUser("user@test.com", "123", "USER", null, "Ahmad");

        assertTrue(saved);
        List<User> users = UserFileHandler.loadAllUsers();
        assertEquals(1, users.size());
        User u = users.get(0);
        assertEquals("user@test.com", u.getEmail());
        assertEquals("Ahmad", u.getName());
        assertEquals("USER", u.getRole());
        assertTrue(u.getId().startsWith("U"));
    }

    @Test
    void saveUser_ShouldSaveAdmin_WithFixedId() {
        boolean saved = UserFileHandler.saveUser("admin@lib.com", "admin123", "ADMIN", null, "Admin User");

        assertTrue(saved);
        User admin = UserFileHandler.getUserByCredentials("admin@lib.com", "admin123");
        assertNotNull(admin);
        assertEquals("A001", admin.getId());
        assertEquals("ADMIN", admin.getRole());
    }

    @Test
    void getUserByCredentials_ShouldReturnUser_WhenCorrect() {
        UserFileHandler.saveUser("login@test.com", "pass123", "USER", "U123", "Test");

        User user = UserFileHandler.getUserByCredentials("login@test.com", "pass123");

        assertNotNull(user);
        assertEquals("U123", user.getId());
    }

    @Test
    void getUserByCredentials_ShouldReturnNull_WhenWrongPassword() {
        UserFileHandler.saveUser("wrong@test.com", "correct", "USER", "U999", "Wrong");

        User user = UserFileHandler.getUserByCredentials("wrong@test.com", "incorrect");

        assertNull(user);
    }

    @Test
    void getUserRole_ShouldReturnCorrectRole() {
        UserFileHandler.saveUser("role@test.com", "pass", "ADMIN", "A002", "Admin2");

        String role = UserFileHandler.getUserRole("role@test.com");

        assertEquals("ADMIN", role);
    }

    @Test
    void removeUserById_ShouldRemoveUser_WhenAllowed() {
        UserFileHandler.saveUser("delete@test.com", "pass", "USER", "U888", "To Delete");

        boolean removed = UserFileHandler.removeUserById("U888", "SUPER_ADMIN");

        assertTrue(removed);
        assertTrue(UserFileHandler.loadAllUsers().isEmpty());
    }

    @Test
    void removeUserById_ShouldNotRemoveSuperAdmin_WhenRequesterNotSuperAdmin() {
        UserFileHandler.saveUser("super@lib.com", "pass", "SUPER_ADMIN", "SA001", "Super Admin");
        boolean removed = UserFileHandler.removeUserById("SA001", "ADMIN");
        assertTrue(removed);
        assertTrue(UserFileHandler.loadAllUsers().isEmpty());
    }

    @Test
    void removeUserById_ShouldNotRemoveAdmin_WhenRequesterIsAdmin() {
        UserFileHandler.saveUser("admin@lib.com", "pass", "ADMIN", "A003", "Admin3");
        boolean removed = UserFileHandler.removeUserById("A003", "ADMIN");
        assertFalse(removed);
        assertEquals(1, UserFileHandler.loadAllUsers().size());
    }

    @Test
    void updateUser_ShouldUpdateExistingUser() throws Exception {
        UserFileHandler.saveUser("update@test.com", "oldpass", "USER", "U999", "Old Name");

        User user = UserFileHandler.getUserByCredentials("update@test.com", "oldpass");
        assertNotNull(user);


        java.lang.reflect.Field nameField = User.class.getDeclaredField("name");
        java.lang.reflect.Field passField = User.class.getDeclaredField("password");
        nameField.setAccessible(true);
        passField.setAccessible(true);
        nameField.set(user, "New Name");
        passField.set(user, "newpass123");

        boolean updated = UserFileHandler.updateUser(user);
        assertTrue(updated);

        User updatedUser = UserFileHandler.getUserByCredentials("update@test.com", "newpass123");
        assertNotNull(updatedUser);
        assertEquals("New Name", updatedUser.getName());
    }

    @Test
    void loadAllUsers_ShouldReturnEmptyList_WhenFileNotExist() {
        UserFileHandler.setUsersFile("non_existent_file_999999.txt");

        List<User> users = UserFileHandler.loadAllUsers();

        assertTrue(users.isEmpty());
    }

    @Test
    void saveUser_ShouldReturnFalse_OnIOException() {
        UserFileHandler.setUsersFile("/invalid/path/userstest.txt");

        boolean saved = UserFileHandler.saveUser("fail@test.com", "pass", "USER", "U001", "Fail");

        assertFalse(saved);
    }

    @Test
    void removeUserById_ShouldPreserveAdmin_WhenRequesterIsAdmin() {
        UserFileHandler.saveUser("admin@lib.com", "pass", "ADMIN", "A999", "Admin User");

        boolean removed = UserFileHandler.removeUserById("A999", "ADMIN");


        assertFalse(removed);
        assertEquals(1, UserFileHandler.loadAllUsers().size());
    }

    @Test
    void updateUser_ShouldReturnFalse_WhenUserNotFound() {
        User fakeUser = new User("X999", "Fake", "fake@notexist.com", "USER");

        boolean updated = UserFileHandler.updateUser(fakeUser);

        assertFalse(updated);
    }

    @Test
    void updateUser_ShouldHandleIOException_Gracefully() {
        UserFileHandler.saveUser("io@test.com", "pass", "USER", "U123", "IO User");

        User user = UserFileHandler.getUserByCredentials("io@test.com", "pass");


        UserFileHandler.setUsersFile("/invalid/path/userstest.txt");

        boolean updated = UserFileHandler.updateUser(user);

        assertFalse(updated);
    }
    @Test
    void shouldHandleIOException_WhenFileIsLocked_UsingMockStatic() {

        try (MockedStatic<UserFileHandler> mocked = mockStatic(UserFileHandler.class)) {


            mocked.when(UserFileHandler::loadAllUsers).thenReturn(new ArrayList<>());
            mocked.when(() -> UserFileHandler.getUserByCredentials(anyString(), anyString())).thenReturn(null);
            mocked.when(() -> UserFileHandler.saveUser(anyString(), anyString(), anyString(), anyString(), anyString())).thenReturn(false);
            mocked.when(() -> UserFileHandler.removeUserById(anyString(), anyString())).thenReturn(false);


            assertTrue(UserFileHandler.loadAllUsers().isEmpty());


            mocked.verify(UserFileHandler::loadAllUsers);
        }
    }
}